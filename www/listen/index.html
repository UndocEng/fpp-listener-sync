<!doctype html>

<html>

<head>

  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <title>Listen</title>

  <style>

    body { font-family: system-ui, sans-serif; margin: 0; padding: 18px; background: #111; color: #eee; }

    .header { text-align: center; margin-bottom: 16px; }

    .header img { width: 80px; height: 80px; }

    .header h2 { margin: 8px 0 4px 0; color: #00e5ff; font-size: 36px; font-weight: 700; }

    .small { opacity: .7; font-size: 14px; }

    button { font-size: 22px; padding: 14px 18px; width: 100%; border: 2px solid #00e5ff; border-radius: 10px; background: #222; color: #00e5ff; cursor: pointer; }

    button:disabled { opacity: 0.5; cursor: default; }

    .idle-msg { text-align: center; margin-top: 24px; padding: 20px; border: 1px solid #333; border-radius: 10px; background: #1a1a1a; color: #888; font-size: 16px; }

    .now-playing { text-align: center; margin-top: 16px; padding: 14px; border: 1px solid #00e5ff; border-radius: 10px; background: #0a1a1f; font-size: 18px; color: #00e5ff; }

    .debug-toggle { margin-top: 16px; font-size: 13px; opacity: 0.5; }

    .debug-toggle label { cursor: pointer; }

    .box { margin-top: 8px; padding: 12px; border: 1px solid #333; border-radius: 10px; background: #1a1a1a; font-size: 13px; color: #aaa; }

    .box b { color: #ccc; }

    .err { color: #f44; font-weight: 600; }

    .hidden { display: none; }

  </style>

</head>

<body>

  <div class="header">

    <img src="logo.png" alt="Undocumented Engineer" />

    <h2>Show Audio</h2>

    <p class="small" style="font-size: 11px; opacity: 0.6; margin-top: -4px;" id="version">v1.0.0</p>

    <p class="small">Tap once to enable audio. Keep this page open during the show.</p>

  </div>

  <button id="enableBtn">Enable Audio</button>

  <div id="idleMsg" class="idle-msg">No show is currently broadcasting.</div>

  <div id="nowPlaying" class="now-playing hidden">&#9835; Now Playing: <span id="trackName">-</span></div>

  <div class="err" id="fetchErr"></div>

  <div class="err" id="playErr"></div>

  <div class="debug-toggle"><label><input type="checkbox" id="debugCheck" /> Show Debug Data</label></div>

  <div id="debugBox" class="box hidden">

    <div><b>Poll:</b> <span id="poll">not started</span></div>

    <div><b>Sequence:</b> <span id="seq">-</span></div>

    <div><b>State:</b> <span id="state">-</span></div>

    <div><b>Target:</b> <span id="target">-</span> ms</div>

    <div><b>Local:</b> <span id="local">-</span> ms</div>

    <div><b>Error (instant):</b> <span id="err">-</span> ms</div>

    <div><b>Error (averaged):</b> <span id="avgErrUsed">-</span> ms</div>

    <div><b>Avg Error (2s):</b> <span id="avgErr2s">-</span> ms</div>

    <div><b>Avg Error (all):</b> <span id="avgErrAll">-</span> ms</div>

    <div><b>Initial Error (0.5s):</b> <span id="initErr">-</span> ms</div>

    <div><b>Playback Rate:</b> <span id="playRate">1.0</span></div>

    <div><b>Buffered:</b> <span id="buffered">-</span> s</div>

    <div><b>Ready State:</b> <span id="readyState">-</span></div>

  </div>

  <audio id="audio" preload="auto" playsinline></audio>

<script>

const enableBtn=document.getElementById('enableBtn'),audio=document.getElementById('audio'),idleMsg=document.getElementById('idleMsg'),nowPlaying=document.getElementById('nowPlaying'),trackName=document.getElementById('trackName'),pollEl=document.getElementById('poll'),fetchErrEl=document.getElementById('fetchErr'),playErrEl=document.getElementById('playErr'),seqEl=document.getElementById('seq'),stateEl=document.getElementById('state'),targetEl=document.getElementById('target'),localEl=document.getElementById('local'),errEl=document.getElementById('err'),avgErrUsedEl=document.getElementById('avgErrUsed'),avgErr2sEl=document.getElementById('avgErr2s'),avgErrAllEl=document.getElementById('avgErrAll'),initErrEl=document.getElementById('initErr'),playRateEl=document.getElementById('playRate'),bufferedEl=document.getElementById('buffered'),readyStateEl=document.getElementById('readyState'),debugCheck=document.getElementById('debugCheck'),debugBox=document.getElementById('debugBox');

let enabled=false,currentBase="",pollTimer=null,haveMetadata=false,needInitialSeek=false;

// Clock offset estimation (NTP-style)
let offsetMs=0;
let bestRttMs=Infinity;

// PLL controller state
let pllLastErr=0;
let pllLastTime=0;

function clamp(v,lo,hi){return Math.max(lo,Math.min(hi,v));}

debugCheck.addEventListener('change',()=>{debugBox.classList.toggle('hidden',!debugCheck.checked);});

audio.addEventListener('loadedmetadata',()=>{haveMetadata=true;});

audio.addEventListener('error',()=>{playErrEl.textContent="No matching audio file detected";});

enableBtn.onclick=()=>{enabled=true;enableBtn.disabled=true;enableBtn.textContent="Audio Enabled";pollEl.textContent="POLLING...";if(pollTimer)clearInterval(pollTimer);pollTimer=setInterval(pollOnce,250);pollOnce();try{audio.muted=true;const p=audio.play();if(p&&typeof p.then==='function'){p.then(()=>{audio.pause();audio.currentTime=0;audio.muted=false;}).catch((e)=>{audio.muted=false;});}else{audio.muted=false;}}catch(e){audio.muted=false;}};

async function pollOnce(){
if(!enabled)return;
const t0Perf=performance.now();
const t0Wall=Date.now();
try{
const url=`${location.origin}/listen/status.php?ts=${Date.now()}`;
const r=await fetch(url,{cache:'no-store'});
if(!r.ok)throw new Error(`HTTP ${r.status}`);
const msg=await r.json();
const t1Perf=performance.now();
const rttMs=t1Perf-t0Perf;
// Update clock offset using best RTT samples
if(msg.server_ms_start&&msg.server_ms_end){
const serverMid=(msg.server_ms_start+msg.server_ms_end)/2;
const clientMid=t0Wall+(rttMs/2);
const newOffset=serverMid-clientMid;
if(rttMs<bestRttMs){
offsetMs=newOffset;
bestRttMs=rttMs;
}else{
offsetMs=0.9*offsetMs+0.1*newOffset; // Smooth
}
}
pollEl.textContent=`ok (${Math.round(rttMs)} ms)`;
fetchErrEl.textContent="";
sync(msg);
}catch(e){
pollEl.textContent="FAILED";
fetchErrEl.textContent="Fetch error: "+(e?.message||e);
}
}

async function safePlay(){try{const p=audio.play();if(p&&typeof p.catch==='function'){await p;}playErrEl.textContent="";}catch(e){playErrEl.textContent="Audio playback blocked: "+(e?.message||e);}}

// Position averaging for smooth sync
let posHistory=[];
const POS_HISTORY_SIZE=2;

// Error tracking for statistics
let errHistory2s=[];
let errHistoryAll=[];
let errHistoryInit=[];
let initErrCalculated=false;
const ERR_2S_SIZE=8; // 2 seconds at 250ms poll rate
const ERR_INIT_SIZE=2; // First 500ms (2 polls at 250ms)

async function sync(msg){seqEl.textContent=msg.base||"-";stateEl.textContent=msg.state||"-";targetEl.textContent=msg.pos_ms??"-";if(msg.state==="stop"||!msg.base){idleMsg.classList.remove('hidden');nowPlaying.classList.add('hidden');playErrEl.textContent="";}else{idleMsg.classList.add('hidden');nowPlaying.classList.remove('hidden');trackName.textContent=msg.base;}if(msg.base&&msg.base!==currentBase){currentBase=msg.base;haveMetadata=false;needInitialSeek=true;audio.playbackRate=1.0;audio.src=msg.mp3_url||"";audio.load();posHistory=[];errHistory2s=[];errHistoryAll=[];errHistoryInit=[];initErrCalculated=false;pllLastErr=0;pllLastTime=0;}if(msg.state==="stop"){audio.pause();audio.currentTime=0;audio.playbackRate=1.0;posHistory=[];errHistory2s=[];errHistoryAll=[];errHistoryInit=[];initErrCalculated=false;needInitialSeek=false;pllLastErr=0;pllLastTime=0;return;}if(msg.state==="pause"){audio.pause();audio.playbackRate=1.0;posHistory=[];errHistory2s=[];errHistoryAll=[];errHistoryInit=[];initErrCalculated=false;needInitialSeek=false;pllLastErr=0;pllLastTime=0;return;}// Time calculation with clock offset compensation
const nowMs=Date.now();
const nowServerMs=nowMs+offsetMs; // Convert phone time to server time
let serverMs=Number(msg.server_ms);
if(!Number.isFinite(serverMs)||serverMs<1000000000000){serverMs=nowServerMs;}
const smoothPosMs=Number(msg.pos_ms||0)+(nowServerMs-serverMs);
posHistory.push(smoothPosMs);
if(posHistory.length>POS_HISTORY_SIZE)posHistory.shift();
const avgPosMs=posHistory.reduce((a,b)=>a+b,0)/posHistory.length;
const targetSec=avgPosMs/1000.0;const localSec=audio.currentTime||0;const errMs=(targetSec-localSec)*1000.0;localEl.textContent=Math.round(localSec*1000);errEl.textContent=Math.round(errMs);errHistory2s.push(errMs);if(errHistory2s.length>ERR_2S_SIZE)errHistory2s.shift();errHistoryAll.push(errMs);const avgErr2s=errHistory2s.length>0?(errHistory2s.reduce((a,b)=>a+b,0)/errHistory2s.length):0;const avgErrAll=errHistoryAll.length>0?(errHistoryAll.reduce((a,b)=>a+b,0)/errHistoryAll.length):0;avgErr2sEl.textContent=Math.round(avgErr2s);avgErrAllEl.textContent=Math.round(avgErrAll);if(!initErrCalculated&&errHistoryInit.length<ERR_INIT_SIZE){errHistoryInit.push(errMs);}if(!initErrCalculated&&errHistoryInit.length>=ERR_INIT_SIZE){const avgInitErr=errHistoryInit.reduce((a,b)=>a+b,0)/errHistoryInit.length;initErrEl.textContent=Math.round(avgInitErr);initErrCalculated=true;}let bufferedSec=0;if(audio.buffered.length>0){bufferedSec=audio.buffered.end(audio.buffered.length-1)-localSec;}bufferedEl.textContent=bufferedSec.toFixed(1);playRateEl.textContent=audio.playbackRate.toFixed(3);readyStateEl.textContent=audio.readyState;if(audio.paused)await safePlay();// Initial seek when track starts
if(needInitialSeek&&!audio.paused){
audio.currentTime=Math.max(0,Math.min(audio.duration||999999,targetSec));
needInitialSeek=false;
posHistory=[];
pllLastErr=0;
pllLastTime=0;
return;
}

if(!haveMetadata||!Number.isFinite(audio.duration)||audio.duration<=0){
audio.playbackRate=1.0;
return;
}

avgErrUsedEl.textContent=Math.round(errMs);

// Hard seek if error > 250ms
if(Math.abs(errMs)>250){
audio.currentTime=Math.max(0,Math.min(audio.duration-0.05,targetSec));
audio.playbackRate=1.0;
pllLastErr=0;
pllLastTime=0;
return;
}

// PLL controller: Proportional + Derivative
const nowTime=Date.now();
const dt=pllLastTime>0?(nowTime-pllLastTime):250;
pllLastTime=nowTime;

const Kp=0.00008; // Proportional gain
const Kd=0.0002; // Derivative gain (damping)

const proportional=Kp*errMs;
const derivative=Kd*(errMs-pllLastErr)/(dt/1000); // Error rate of change
pllLastErr=errMs;

const adjustment=proportional+derivative;
audio.playbackRate=clamp(1.0+adjustment,0.98,1.02); // Â±2% limit
}

// Fetch and display version (cache-busting)
fetch('/listen/version.php?t='+Date.now()).then(r=>r.text()).then(v=>document.getElementById('version').textContent='v'+v.trim()).catch(()=>{});

</script>

</body>

</html>